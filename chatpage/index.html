<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Talk to Repo (Local)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 18px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-bottom: 14px; }
    textarea, input, button { font: inherit; }
    textarea { width: 100%; min-height: 90px; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row > * { margin: 4px 0; }
    input[type="number"], input[type="text"] { padding: 8px; border-radius: 10px; border: 1px solid #ccc; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #333; background: #111; color: #fff; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; }
    .muted { color: #666; font-size: 0.92rem; }
    .sources { margin-top: 10px; }
    .source { padding: 8px 10px; border: 1px solid #eee; border-radius: 10px; margin-top: 8px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 0.85rem; margin-left: 8px; color:#444; }
    .error { color: #b00020; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin: 8px 0 2px;">The Mindset Of An IT Architect</h1>
    <div class="muted">Ask your question</div>

    <div class="card" style="margin-top: 14px;">
      <div class="row" style="display:none;" >
        <label>
          API Settings
          <input id="apiUrl" type="text" value="http://127.0.0.1:8000/chat" style="width: 360px;" />
        </label>
        <label>
          top_k
          <input id="topK" type="number" min="1" max="20" value="5" style="width: 90px;" />
        </label>
        
      </div>
      <div>
        <button id="sendBtn">Send</button>
        <button id="clearBtn" style="background:#fff;color:#111;border-color:#ccc;">Clear</button>
      </div>

      <div style="margin-top: 10px;">
        <textarea id="message" placeholder="Ask a question about the repo..."></textarea>
      </div>

      <div id="status" class="muted" style="margin-top:10px;"></div>
      <div id="error" class="error" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3 style="margin: 0 0 10px;">Answer</h3>
      <div id="answer" class="muted">No response yet.</div>

      <div class="sources">
        <h3 style="margin: 14px 0 10px;">Sources</h3>
        <div id="sources" class="muted">—</div>
      </div>
    </div>


  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setStatus(msg) { $("status").textContent = msg || ""; }
    function setError(msg) { $("error").textContent = msg || ""; }
    function setAnswer(text) {
      const el = $("answer");
      el.className = "";
      el.innerHTML = marked.parse(text || "");
  }


    function renderSources(sources) {
      const el = $("sources");
      el.innerHTML = "";
      if (!sources || sources.length === 0) {
        el.textContent = "—";
        el.className = "muted";
        return;
      }
      sources.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "source";
        const title = document.createElement("div");
        
        //title.innerHTML = `<strong>${escapeHtml(s.title || "Untitled")}</strong> <span class="pill">${escapeHtml(s.path || "")}</span>`;
        
        title.innerHTML = `<a href="TMOAA/${escapeHtml(s.path || "")}" class="pill">${escapeHtml(s.path || "")}</a>`;
        
        div.appendChild(title);
        el.appendChild(div);
      });
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    async function send() {
      setError("");
      const url = $("apiUrl").value.trim();
      const message = $("message").value.trim();
      const top_k = Number($("topK").value) || 5;

      if (!url) { setError("Please set API URL."); return; }
      if (!message) { setError("Please type a message."); return; }

      $("sendBtn").disabled = true;
      setStatus("Sending…");

      try {
        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, top_k })
        });

        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error(`HTTP ${resp.status}: ${txt}`);
        }

        const data = await resp.json();
        setAnswer(data.answer || "");
        renderSources(data.sources || []);
        setStatus("Done.");
      } catch (err) {
        setStatus("");
        setError(err?.message || String(err));
      } finally {
        $("sendBtn").disabled = false;
      }
    }

    $("sendBtn").addEventListener("click", send);
    $("clearBtn").addEventListener("click", () => {
      $("message").value = "";
      setAnswer("No response yet.");
      renderSources([]);
      setError("");
      setStatus("");
      $("message").focus();
    });

    $("message").addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") send();
    });
  </script>
</body>
</html>
